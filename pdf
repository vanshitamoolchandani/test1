package com.example.pdfconverter.util;

import com.adobe.pdfservices.operation.PDFServices;
import com.adobe.pdfservices.operation.PDFServicesMediaType;
import com.adobe.pdfservices.operation.PDFServicesResponse;
import com.adobe.pdfservices.operation.auth.Credentials;
import com.adobe.pdfservices.operation.auth.ServicePrincipalCredentials;
import com.adobe.pdfservices.operation.exception.SDKException;
import com.adobe.pdfservices.operation.exception.ServiceApiException;
import com.adobe.pdfservices.operation.exception.ServiceUsageException;
import com.adobe.pdfservices.operation.io.Asset;
import com.adobe.pdfservices.operation.io.StreamAsset;
import com.adobe.pdfservices.operation.pdfjobs.jobs.ExportPDFJob;
import com.adobe.pdfservices.operation.pdfjobs.params.exportpdf.ExportPDFParams;
import com.adobe.pdfservices.operation.pdfjobs.params.exportpdf.ExportPDFTargetFormat;
import com.adobe.pdfservices.operation.pdfjobs.result.ExportPDFResult;
import org.apache.commons.io.IOUtils;

import java.io.*;

public class AdobePdfUtil {

    public static byte[] convertPdfToDocx(InputStream inputStream) {
        try {
            // Load credentials (service account)
            Credentials credentials = new ServicePrincipalCredentials("src/main/resources/pdfservices-api-credentials.json");
            PDFServices pdfServices = new PDFServices(credentials);

            // Create Asset from input stream
            Asset inputAsset = pdfServices.upload(new StreamAsset(inputStream, PDFServicesMediaType.APPLICATION_PDF));

            // Set conversion parameters
            ExportPDFParams exportParams = ExportPDFParams.exportPDFParamsBuilder()
                    .withTargetFormat(ExportPDFTargetFormat.DOCX)
                    .build();

            // Create and execute job
            ExportPDFJob job = new ExportPDFJob(inputAsset, exportParams);
            PDFServicesResponse<ExportPDFResult> response = pdfServices.submit(job).getFinalResult();

            // Get the converted file
            Asset resultAsset = response.getResult().getAsset();
            InputStream resultStream = pdfServices.getContent(resultAsset).getInputStream();

            // Convert stream to byte array
            return IOUtils.toByteArray(resultStream);

        } catch (IOException | ServiceApiException | ServiceUsageException | SDKException e) {
            throw new RuntimeException("PDF to DOCX conversion failed", e);
        }
    }
}


package com.example.pdfconverter.service;

import com.example.pdfconverter.util.AdobePdfUtil;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

@Service
public class PdfService {

    public byte[] convertPdfToDocx(MultipartFile file) {
        try {
            return AdobePdfUtil.convertPdfToDocx(file.getInputStream());
        } catch (IOException e) {
            throw new RuntimeException("Failed to read input file", e);
        }
    }
}




@PostMapping(value = "/convert", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
public ResponseEntity<byte[]> convertPdfToDocx(@RequestParam("file") MultipartFile file) {
    byte[] convertedFile = pdfService.convertPdfToDocx(file);

    // Extract original file name without extension
    String originalFilename = file.getOriginalFilename();
    String outputFilename = "converted.docx"; // fallback

    if (originalFilename != null && originalFilename.contains(".")) {
        int dotIndex = originalFilename.lastIndexOf('.');
        outputFilename = originalFilename.substring(0, dotIndex) + ".docx";
    }

    HttpHeaders headers = new HttpHeaders();
    headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);
    headers.setContentDisposition(ContentDisposition.attachment()
            .filename(outputFilename)
            .build());

    return new ResponseEntity<>(convertedFile, headers, HttpStatus.OK);
