reader.onload = (e: any) => {
  try {
    const bstr: string = e.target.result;
    const wb: XLSX.WorkBook = XLSX.read(bstr, { type: 'binary' });

    const wsname: string = wb.SheetNames[0];
    const ws: XLSX.WorkSheet = wb.Sheets[wsname];

    // Treat the first row as headers
    const data: any = XLSX.utils.sheet_to_json(ws, { header: 1 });

    // ✅ Guard: if file is not a real excel/has no rows, treat as invalid
    if (!data || !data.length || !data[0]) {
      this.toaster.error("Invalid file.");
      this.excelShowData = [];
      this.takeInput1.nativeElement.value = null;
      return;
    }

    if (data && data.length && data[0].indexOf("GenInvo") < 0) {
      this.toaster.error("Invalid file.");
      this.excelShowData = [];
      this.takeInput1.nativeElement.value = null;
      return;
    }

    this.showExcelDataFlag = true;
    data[0].splice(data[0].length - 1, 1);
    this.excelShowData = [];
    this.excelShowData = data;

    let headers: any;
    headers = data[0];
    const result: any = {};

    headers.forEach((header: string) => {
      result[header] = [];
    });

    data.slice(1).forEach((row: any) => {
      headers.entries().forEach((header: string, index: number) => {
        if (row[index] !== undefined) {
          result[header[1]].push(row[index]);
        }
      });
    });

    if (this.checkInvalidExcel(result)) {
      this.excelShowData = [];
      this.takeInput1.nativeElement.value = null;
      return;
    }

    this.utilityService.createAudit(
      'Parameter',
      'File uploaded successfully in Synthetic data tab saved successfully.',
      "File upload successfully in Synthetic data tab under " +
        sessionStorage.getItem('projectName') +
        "-" +
        sessionStorage.getItem('version').substring(0, sessionStorage.getItem('version').lastIndexOf(" ")) +
        ".",
      'Create'
    );

    this.apiData = {
      projectName: sessionStorage.getItem("projectName"),
      version: sessionStorage.getItem("version").substring(0, sessionStorage.getItem("version").lastIndexOf(' ')),
      user_id: sessionStorage.getItem("user_id"),
      terms: result,
      excelData: this.excelShowData
    };

    console.log(this.apiData);
    this.takeInput1.nativeElement.value = null;
  } catch (err) {
    // ✅ Fix: Word/docx parsing errors now show Invalid file like .py
    this.toaster.error("Invalid file.");
    this.excelShowData = [];
    this.takeInput1.nativeElement.value = null;
    return;
  }
};